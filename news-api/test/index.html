<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ThreatFeed – Cybersecurity News</title>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { --accent: #00ff41; --bg: #0d1117; --surface: #161b22; --text: #c9d1d9; --muted: #8b949e; }
        * { box-sizing: border-box; }
        body {
            font-family: 'Fira Code', monospace;
            line-height: 1.6;
            margin: 0;
            background-color: var(--bg);
            color: var(--text);
            padding: 2rem;
            background-image:
                linear-gradient(rgba(0,255,65,.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,255,65,.03) 1px, transparent 1px);
            background-size: 20px 20px;
            animation: scanlines 8s linear infinite;
        }
        @keyframes scanlines {
            0% { background-position-y: 0; }
            100% { background-position-y: 20px; }
        }
        h1, h2 { color: var(--accent); margin: 0 0 1rem; letter-spacing: .05em; }
        h1 span { animation: flicker 3s infinite; }
        @keyframes flicker {
            0%, 100% { opacity: 1; }
            50% { opacity: .7; }
        }
        #controls {
            margin-bottom: 2rem;
            padding: 1rem 1.5rem;
            background-color: var(--surface);
            border: 1px solid var(--muted);
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: .75rem;
        }
        @media (max-width: 600px) {
            #controls {
                flex-direction: column;
                align-items: stretch;
            }
            #controls select,
            #controls button,
            #controls .date-wrapper {
                width: 100%;
            }
        }
        #controls label { color: var(--muted); font-size: .875rem; }
        #controls select {
            padding: .5rem 1.75rem .5rem .75rem;
            background-color: var(--surface);
            color: var(--text);
            border: 1px solid var(--muted);
            font-family: inherit;
            font-size: .875rem;
            transition: border-color .2s;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='5' viewBox='0 0 10 5'%3E%3Cpath fill='%2300ff41' d='M0 0l5 5 5-5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right .75rem center;
            background-size: 10px 5px;
        }
        #controls button, #controls input[type="date"] {
            padding: .5rem .75rem;
            text-align: center;
            background-color: var(--surface);
            color: var(--text);
            border: 1px solid var(--muted);
            font-family: inherit;
            font-size: .875rem;
            transition: border-color .2s;
        }
        #controls .date-wrapper {
            position: relative;
            width: 135px;
        }
        #controls .date-wrapper input[type="date"] {
            width: 100%;
            background: transparent;
            position: initial;
            top: 0; left: 0;
            height: 100%;
            cursor: pointer;
            z-index: 3;
        }
        .calendar-icon-stack {
            position: absolute;
            top: 50%;
            right: .75rem;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            pointer-events: none;
        }
        .calendar-icon-stack svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        #controls button {
            cursor: pointer;
            border-color: var(--accent);
            color: var(--accent);
            position: relative;
            overflow: hidden;
            transition: background-color .2s;
        }
        #controls button:hover { background-color: var(--accent); color: #000; }
        #controls button::after {
            content: '';
            position: absolute;
            top: -50%; left: -50%;
            width: 200%; height: 200%;
            background: linear-gradient(45deg, transparent, rgba(0,255,65,.4), transparent);
            transform: rotate(45deg);
            animation: glare 2s infinite;
        }
        @keyframes glare {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); } 
        }
        #news {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
        }
        .article {
            background-color: var(--surface);
            padding: 1.25rem 1.75rem;
            border: 1px solid var(--muted);
            border-radius: 4px;
            position: relative;
            transition: transform .2s, box-shadow .2s;
            box-shadow: 0 0 8px rgba(0,255,65,.15);
        }
        .article:hover {
            transform: translateY(-3px);
            box-shadow: 0 0 12px rgba(0,255,65,.25);
        }
        .article h3 {
            margin: 0 0 .5rem;
            font-size: 1.125rem;
        }
        .article a {
            color: var(--text);
            text-decoration: none;
            transition: color .2s;
        }
        .article a:hover {
            color: var(--accent);
            text-shadow: 0 0 4px var(--accent);
        }
        .article img {
            max-width: 100%;
            height: auto;
            margin: .5rem 0;
            border: 1px solid var(--muted);
            filter: grayscale(1) brightness(.9);
            transition: filter .2s;
        }
        .article:hover img { filter: grayscale(0) brightness(1); }
        .article p {
            margin: 0;
        }
        #ad {
            margin-bottom: 2rem;
            text-align: center;
        }
        #ad img {
            max-width: 100%;
            border: 1px solid var(--muted);
        }
        footer {
            margin-top: 3rem;
            color: var(--muted);
            font-size: .75rem;
            text-align: center;
        }

        #threat-score-section {
            margin-bottom: 2rem;
            padding: 1rem 1.5rem;
            background-color: var(--surface);
            border: 1px solid var(--muted);
        }

        #threat-score-section h2 {
            margin-top: 0;
            margin-bottom: 1rem;
        }

        #threat-meter-container {
            width: 100%;
            height: 20px;
            background-color: var(--muted);
            border-radius: 10px;
            overflow: hidden;
        }

        #threat-meter-fill {
            height: 100%;
            width: 0%; /* Will be controlled by JS */
            transition: width 0.5s ease-in-out, background-color 0.5s ease-in-out;
        }

        /* Color classes for the meter */
        .threat-low {
            background-color: #28a745; /* Green */
        }

        .threat-medium {
            background-color: #ffc107; /* Yellow */
        }

        .threat-high {
            background-color: #dc3545; /* Red */
        }

        .threat-bar {
            height: 100%;
            transition: width 0.5s ease-in-out;
        }
    </style>
</head>
<body>

    <h1>ThreatFeed <span>–</span> Cybersecurity News</h1>

    <div id="controls">
        <label for="source-select">Source:</label>
        <select id="source-select">
            <option value="all">All Sources</option>
            <!-- Populated by JS -->
        </select>

        <label for="category-select">Category:</label>
        <select id="category-select">
            <option value="all">All Categories</option>
            <option value="Cybersecurity">Cybersecurity</option>
            <option value="Tech">Tech</option>
            <option value="Defense">Defense</option>
            <option value="General">General</option>
        </select>

        <label for="num-articles">Limit:</label>
        <select id="num-articles">
            <option value="5">5</option>
            <option value="10">10</option>
            <option value="20">20</option>
            <option value="50">50</option>
            <option value="all">All</option>
        </select>

        <label for="date-start">From:</label>
        <div class="date-wrapper">
            <input type="date" id="date-start">
            <span class="calendar-icon-stack">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="var(--accent)"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11zM5 7V6h14v1H5z"/></svg>
            </span>
        </div>

        <label for="date-end">To:</label>
        <div class="date-wrapper">
            <input type="date" id="date-end">
            <span class="calendar-icon-stack">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="var(--accent)"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11zM5 7V6h14v1H5z"/></svg>
            </span>
        </div>

        <label for="sort-by">Sort by:</label>
        <select id="sort-by">
            <option value="publishedAt">Date</option>
            <option value="rank">Rank</option>
        </select>
    </div>

    <div id="threat-score-section">
        <h2>Today in ThreatFeed:</h2>
        <div id="threat-meter-container" style="display: flex; height: 20px; border-radius: 10px; overflow: hidden; background-color: var(--muted);">
            <!-- Bars will be dynamically added by JS -->
        </div>
        <p style="text-align: center; margin-top: 0.5rem; font-size: 0.875rem; color: var(--muted);" id="threat-score-summary">Loading data...</p>
    </div>

    <div id="ad"></div>

    <h2>Latest Articles</h2>
    <div id="news"></div>

    <footer>ThreatFeed – Real-time cybersecurity news aggregation</footer>

    <script>
        const rssSources = [
            // Cybersecurity News
            "https://www.bleepingcomputer.com/feed/",
            "https://feeds.feedburner.com/TheHackersNews",
            "https://blogs.cisco.com/security/feed",
            "https://www.wired.com/feed/category/security/latest/rss",
            "https://www.securityweek.com/feed/",
            "https://news.sophos.com/en-us/feed/",
            "https://www.csoonline.com/feed/",
            // Tech News
            "https://www.theverge.com/rss/index.xml",
            "https://techcrunch.com/feed/",
            "https://arstechnica.com/feed/",
            "http://www.engadget.com/rss-full.xml",
            "http://www.fastcodesign.com/rss.com",
            "http://www.forbes.com/entrepreneurs/index.xml",
            "https://blog.pragmaticengineer.com/rss/",
            "https://browser.engineering/rss.xml",
            "https://githubengineering.com/atom.xml",
            "https://joshwcomeau.com/rss.xml",
            "https://jvns.ca/atom.xml",
            "https://overreacted.io/rss.xml",
            "https://signal.org/blog/rss.xml",
            "https://slack.engineering/feed",
            "https://stripe.com/blog/feed.rss",
            // Defense News
            "https://idrw.org/category/news-beat/feed/",
            "https://defence-blog.com/feed",
            "https://www.defenseone.com/rss/all/",
            "https://thediplomat.com/category/asia-defense/feed/",
            "https://www.janes.com/osint-insights/defence-news/feed/",
            "https://www.militarytimes.com/arc/outboundfeeds/news-rss/",
            "https://www.defensenews.com/arc/outboundfeeds/home-rss/",
        ];

        document.addEventListener('DOMContentLoaded', () => {
            const sourceSelect = document.getElementById('source-select');
            const categorySelect = document.getElementById('category-select'); // New variable
            const numArticlesSelect = document.getElementById('num-articles');
            const dateStartInput = document.getElementById('date-start');
            const dateEndInput = document.getElementById('date-end');
            const sortBySelect = document.getElementById('sort-by');
            const applyFiltersButton = document.getElementById('apply-filters');
            const newsContainer = document.getElementById('news');
            const adContainer = document.getElementById('ad');

            // Populate source dropdown
            rssSources.forEach(sourceUrl => {
                const option = document.createElement('option');
                option.value = sourceUrl;
                const urlParts = sourceUrl.split('/');
                let domain = urlParts[2];
                if (domain.includes('feedburner.com')) {
                    domain = urlParts[urlParts.length - 1];
                }
                option.textContent = domain.replace('www.', '').replace('.com', '').replace('.org', '').replace('.net', '').replace('rss', '').replace('all', '').replace('/', '');
                sourceSelect.appendChild(option);
            });

            const fetchAd = () => {
                return fetch('/ad')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        adContainer.innerHTML = '';
                        const adLink = document.createElement('a');
                        adLink.href = data.targetUrl;
                        adLink.target = '_blank';
                        const adImg = document.createElement('img');
                        adImg.src = data.imageUrl;
                        adLink.appendChild(adImg);
                        adContainer.appendChild(adLink);
                    })
                    .catch(error => {
                        console.error('There has been a problem with your fetch operation:', error);
                        adContainer.innerHTML = '<p>Advertisement could not be loaded.</p>';
                    });
            };

            const fetchNews = () => {
                newsContainer.innerHTML = '<p>Loading articles...</p>'; // Add loading message
                const selectedSource = sourceSelect.value;
                const selectedCategory = categorySelect.value; // New parameter
                const numArticles = numArticlesSelect.value;
                const startDate = dateStartInput.value;
                const endDate = dateEndInput.value;
                const sortBy = sortBySelect.value;

                let newsUrl = '/news';
                const params = new URLSearchParams();

                if (selectedSource !== 'all') {
                    params.append('source', selectedSource);
                }
                if (selectedCategory !== 'all') { // New parameter
                    params.append('category', selectedCategory);
                }
                if (numArticles === 'all') {
                    params.append('limit', '100000'); // Use a large number to approximate fetching all articles
                } else {
                    params.append('limit', numArticles);
                }
                if (startDate) {
                    params.append('start', startDate);
                }
                if (endDate) {
                    params.append('end', endDate);
                }
                if (sortBy) {
                    params.append('sortBy', sortBy);
                }

                if (params.toString()) {
                    newsUrl += `?${params.toString()}`;
                }

                return fetch(newsUrl)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        newsContainer.innerHTML = '';
                        if (data && data.length > 0) {
                            data.forEach(article => {
                                const articleDiv = document.createElement('div');
                                articleDiv.className = 'article';

                                let content = `<h3><a href="${article.url}" target="_blank">${article.title}</a></h3><p>Rank: ${article.rank}</p>`;

                                articleDiv.innerHTML = content;
                                newsContainer.appendChild(articleDiv);
                            });
                        } else {
                            newsContainer.innerHTML = '<p>No articles found.</p>';
                        }
                    })
                    .catch(error => {
                        console.error('There has been a problem with your fetch operation:', error);
                        newsContainer.innerHTML = '<p>News could not be loaded.</p>';
                    });
            };

            const fetchAll = () => {
                fetchAd();
                fetchNews();
                fetchThreatScore();
            }

            // Debounce function
            const debounce = (func, delay) => {
                let timeout;
                return function(...args) {
                    const context = this;
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(context, args), delay);
                };
            };

            const debouncedFetchAll = debounce(fetchAll, 300); // 300ms delay

            // Add event listeners for instant filter application
            sourceSelect.addEventListener('change', debouncedFetchAll);
            categorySelect.addEventListener('change', debouncedFetchAll); // New event listener
            numArticlesSelect.addEventListener('change', debouncedFetchAll);

            const validateDates = (event) => {
                const startDate = dateStartInput.value;
                const endDate = dateEndInput.value;

                if (startDate && endDate && startDate > endDate) {
                    alert("'From' date cannot be after 'To' date.");
                    event.target.value = '';
                }
            };

            const handleDateChange = (event) => {
                validateDates(event);
                debouncedFetchAll();
            };

            dateStartInput.addEventListener('change', handleDateChange);
            dateEndInput.addEventListener('change', handleDateChange);
            sortBySelect.addEventListener('change', debouncedFetchAll);

            const fetchThreatScore = () => {
                fetch('/today-threat')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        const threatMeterContainer = document.getElementById('threat-meter-container');
                        const threatScoreSummary = document.getElementById('threat-score-summary');
                        threatMeterContainer.innerHTML = ''; // Clear previous bars

                        if (data.TotalArticles === 0) {
                            threatScoreSummary.textContent = 'No articles found for today.';
                            return;
                        }

                        const lowPercent = (data.LowRankCount / data.TotalArticles) * 100;
                        const mediumPercent = (data.MediumRankCount / data.TotalArticles) * 100;
                        const highPercent = (data.HighRankCount / data.TotalArticles) * 100;

                        // Create and append bars
                        if (lowPercent > 0) {
                            const lowBar = document.createElement('div');
                            lowBar.style.width = `${lowPercent}%`;
                            lowBar.className = 'threat-bar threat-low';
                            threatMeterContainer.appendChild(lowBar);
                        }
                        if (mediumPercent > 0) {
                            const mediumBar = document.createElement('div');
                            mediumBar.style.width = `${mediumPercent}%`;
                            mediumBar.className = 'threat-bar threat-medium';
                            threatMeterContainer.appendChild(mediumBar);
                        }
                        if (highPercent > 0) {
                            const highBar = document.createElement('div');
                            highBar.style.width = `${highPercent}%`;
                            highBar.className = 'threat-bar threat-high';
                            threatMeterContainer.appendChild(highBar);
                        }

                        threatScoreSummary.textContent = `Low: ${data.LowRankCount} (${lowPercent.toFixed(1)}%) | Medium: ${data.MediumRankCount} (${mediumPercent.toFixed(1)}%) | High: ${data.HighRankCount} (${highPercent.toFixed(1)}%)`;
                    })
                    .catch(error => {
                        console.error('Error fetching threat score:', error);
                        document.getElementById('threat-score-summary').textContent = 'Error loading score data.';
                    });
            };

            // Initial fetch
            fetchAll();
        });
    </script>

</body>
</html>
